# ========================================================================
# NIXPACKS CONFIGURATION - NIX PYTHON VIRTUAL ENVIRONMENT FIX
# ========================================================================
# Critical: Nix Python is externally-managed (PEP 668)
# Solution: Create virtual environment to bypass /nix/store restrictions
# Phase order: setup → install → build (app files copied AFTER install)
# Fix: Move pip install to build phase (runs AFTER app code is copied)
# ========================================================================

[phases.setup]
nixPkgs = ["python311", "postgresql_15"]

[phases.install]
# Create virtual environment only (no pip install yet - no files copied)
cmds = ["python -m venv /opt/venv"]

[phases.build]
# Install dependencies AFTER app files are copied to /app
# Use ABSOLUTE PATH to requirements.txt
cmds = [
  "/opt/venv/bin/pip install --upgrade pip setuptools wheel",
  "/opt/venv/bin/pip install -r /app/requirements.txt --no-cache-dir"
]

# ========================================================================
# PHASE 4: START - Application runtime command
# ========================================================================
[start]
# Use Python from virtual environment (bypasses externally-managed-environment)
cmd = "/opt/venv/bin/python manage.py migrate --noinput && /opt/venv/bin/gunicorn config.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --timeout 120 --access-logfile - --error-logfile - --log-level info"

# ========================================================================
# VARIABLES - Non-sensitive configuration ONLY
# ========================================================================
[variables]
# ✅ SAFE: Python runtime optimization (non-sensitive)
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"
