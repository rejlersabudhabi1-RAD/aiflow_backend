# ========================================================================
# NIXPACKS CONFIGURATION - SIMPLIFIED
# ========================================================================
# Using custom build script instead of inline commands
# This ensures proper context and working directory
# ========================================================================

[phases.setup]
nixPkgs = ["python311", "postgresql_15"]

[phases.build]
# Run custom build script (executes in /app with all files present)
cmds = ["bash build.sh"]

# ========================================================================
# PHASE 4: START - Application runtime command
# ========================================================================
[start]
# Use Python from virtual environment (bypasses externally-managed-environment)
cmd = "/opt/venv/bin/python manage.py migrate --noinput && /opt/venv/bin/gunicorn config.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --timeout 120 --access-logfile - --error-logfile - --log-level info"

# ========================================================================
# VARIABLES - Non-sensitive configuration ONLY
# ========================================================================
[variables]
# âœ… SAFE: Python runtime optimization (non-sensitive)
PYTHONUNBUFFERED = "1"
PYTHONDONTWRITEBYTECODE = "1"
